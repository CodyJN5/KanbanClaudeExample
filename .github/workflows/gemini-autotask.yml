name: "Gemini Task Breakdown"

on:
  issues:
    types: [opened]

permissions:
  issues: write
  contents: read

jobs:
  analyze_task:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Get Issue Details
        id: issue_details
        run: |
          echo "ISSUE_TITLE=${{ github.event.issue.title }}" >> $GITHUB_ENV
          echo "ISSUE_NUMBER=${{ github.event.issue.number }}" >> $GITHUB_ENV

      - name: Call Vertex AI API (Plan B)
        id: gemini
        run: |
          PROMPT="You are a helpful project management assistant. Based on the following new task, please provide a concise 'To-Do' checklist in markdown. Task Title: '${{ env.ISSUE_TITLE }}'."
          
          JSON_PAYLOAD=$(jq -n \
                            --arg content "$PROMPT" \
                            '{contents: [{parts: [{text: $content}]}]}')

          # This is the new Vertex AI endpoint, using your PROJECT_ID
          API_URL="https://us-central1-aiplatform.googleapis.com/v1/projects/${{ secrets.PROJECT_ID }}/locations/us-central1/publishers/google/models/gemini-2.0-flash:generateContent"
          
          # We use x-goog-api-key for the header instead of putting it in the URL
          API_RESPONSE=$(curl -s -X POST "$API_URL" \
                            -H "Authorization: Bearer ${{ secrets.GEMINI_API_KEY }}" \
                            -H "Content-Type: application/json" \
                            -d "$JSON_PAYLOAD")

          # The response format for Vertex AI is slightly different
          GENERATED_TEXT=$(echo "$API_RESPONSE" | jq -r '.candidates[0].content.parts[0].text')

          if [ "$GENERATED_TEXT" == "null" ]; then
            GENERATED_TEXT="Sorry, I couldn't generate a response. API Error: $(echo $API_RESPONSE | jq -r '.error.message')"
          fi

          echo "GEMINI_RESPONSE<<EOF" >> $GITHUB_OUTPUT
          echo "$GENERATED_TEXT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post Checklist as Comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ env.ISSUE_NUMBER }} --body - <<EOF
          **ðŸ¤– Gemini Task Breakdown (Vertex AI):**

          ${{ steps.gemini.outputs.GEMINI_RESPONSE }}
          EOF
