name: "Gemini Task Breakdown"

on:
  issues:
    types: [opened]

permissions:
  issues: write
  contents: read

jobs:
  analyze_task:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Get Issue Details
        id: issue_details
        run: |
          echo "ISSUE_TITLE=${{ github.event.issue.title }}" >> $GITHUB_ENV
          echo "ISSUE_NUMBER=${{ github.event.issue.number }}" >> $GITHUB_ENV

      - name: Call Gemini API
        id: gemini
        run: |
          PROMPT="You are a helpful project management assistant. Based on the following new task, please provide a concise 'To-Do' checklist in markdown. Task Title: '${{ env.ISSUE_TITLE }}'."
          
          JSON_PAYLOAD=$(jq -n \
                            --arg content "$PROMPT" \
                            '{contents: [{parts: [{text: $content}]}]}')

          API_RESPONSE=$(curl -s -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${{ secrets.GEMINI_API_KEY }}" \
                            -H "Content-Type: application/json" \
                            -d "$JSON_PAYLOAD")

          GENERATED_TEXT=$(echo "$API_RESPONSE" | jq -r '.candidates[0].content.parts[0].text')

          if [ "$GENERATED_TEXT" == "null" ]; then
            GENERATED_TEXT="Sorry, I couldn't generate a response. API Error: $(echo $API_RESPONSE | jq -r '.error.message')"
          fi

          echo "GEMINI_RESPONSE<<EOF" >> $GITHUB_OUTPUT
          echo "$GENERATED_TEXT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post Checklist as Comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ env.ISSUE_NUMBER }} --body "**ðŸ¤– Gemini Task Breakdown:**

          ${{ steps.gemini.outputs.GEMINI_RESPONSE }}"
