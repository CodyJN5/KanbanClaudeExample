name: "Gemini Task Breakdown"

on:
  issues:
    types: [opened]

permissions:
  issues: write
  contents: read

jobs:
  analyze_task:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Get Issue Details
        id: issue_details
        run: |
          echo "ISSUE_TITLE=${{ github.event.issue.title }}" >> $GITHUB_ENV
          echo "ISSUE_NUMBER=${{ github.event.issue.number }}" >> $GITHUB_ENV

      - name: Call Gemini API and Write to File
        id: gemini
        run: |
          PROMPT="You are a helpful project management assistant. Based on the following new task, please provide a concise 'To-Do' checklist in markdown. Task Title: '${{ env.ISSUE_TITLE }}'."
          
          JSON_PAYLOAD=$(jq -n \
                            --arg content "$PROMPT" \
                            '{contents: [{parts: [{text: $content}]}]}')

          # This is the model name that we know worked
          API_URL="https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent"

          API_RESPONSE=$(curl -s -X POST "$API_URL" \
                            -H "Content-Type: application/json" \
                            -H "x-goog-api-key: ${{ secrets.GEMINI_API_KEY }}" \
                            -d "$JSON_PAYLOAD")

          GENERATED_TEXT=$(echo "$API_RESPONSE" | jq -r '.candidates[0].content.parts[0].text')

          if [ "$GENERATED_TEXT" == "null" ]; then
            GENERATED_TEXT="Sorry, I couldn't generate a response. API Error: $(echo $API_RESPONSE | jq -r '.error.message')"
          fi
          
          # --- THIS IS THE FIX ---
          # Build the *entire* body string here
          BODY="**ðŸ¤– Gemini Task Breakdown:**

          $GENERATED_TEXT"
          
          # Write the entire body to a file named 'comment-body.txt'
          echo "$BODY" > comment-body.txt

      - name: Post Checklist as Comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Use the --body-file flag to read from the file
          gh issue comment ${{ env.ISSUE_NUMBER }} --body-file comment-body.txt
